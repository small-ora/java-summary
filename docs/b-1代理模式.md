# 代理模式

## 代理模式分为静态代理和动态代理
- 静态代理使用比较简单,但是只能代理一个固定的类,使用起来不灵活
- 动态代理使用起来比较麻烦,但是用起来很灵活,可以代理所有的类
  - 动态代理有两种实现方式,一种是通过jdk实现动态代理,另一种是使用cglib实现动态代理
  - Jdk实现代理模式: 被代理的类必须要实现一个或多个接口,否则jdk不知道代理的类有哪些方法
  - cglib实现的动态代理则不需要,cglib的原理是把生成的代理类继承被代理类
  
## 静态代理详解
1.首先我们有一个Tank类,类里面有一个接口Movable,Tank类实现了Movable接口,并重写了move方法
```java
public class Tank implements Movable{

	@Override
	public void move() {
		System.out.println("Tank move...");
		try {
    //移动消耗的时间
			Thread.sleep(new Random().nextInt(10000));
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
	}

	public static void main(String[] args) {
		new Tank().move();
	}
}

interface Movable{
	void move();
}
```
2.现在我们有个需求,我们需要在调用move方法的时候加个日志,方便后续排查问题,最简单的方法就是在调用move方法之前加上一行日志,但是如果后续我们需要加别的信息,又要修改代码去添加,不是很优雅,所以我们自定义一个类,实现Movable接口,并且拥有Movble作为成员变量
```java
class LogProxy implements Movable{

	Movable movable;
	LogProxy(Movable movable){
		this.movable = movable;
	}

	@Override
	public void move() {
		System.out.println("tank start move");
		movable.move();
		System.out.println("tank stop move");
	}
}
```
这样我们如果需要在move方法上加日志就很简单了,把main里面调用tank的move方法修改为
```java
new LogProxy(new Tank()).move();
```
是不是很优雅,如果我们还想要统计调用move方法消耗的时间,很简单.我们在定义一个统计运行时间的代理类
```java
class TimeProxy implements Movable{

	Movable movable;
	TimeProxy(Movable movable){
		this.movable = movable;
	}

	@Override
	public void move() {
		long start = System.currentTimeMillis();
		movable.move();
		long end = System.currentTimeMillis();
		System.out.println(end-start);
	}
}
```
然后同样的,修改main方法中调用move方法的代码
```java
new TimeProxy(new LogProxy(new Tank())).move();
```
最后,全部的代码如下,这就是静态代理了
```java
public class Tank implements Movable{

	@Override
	public void move() {
		System.out.println("Tank move...");
		try {
			Thread.sleep(new Random().nextInt(10000));
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
	}

	public static void main(String[] args) {
		new LogProxy(new TimeProxy(new Tank())).move();
	}
}

class TimeProxy implements Movable{

	Movable movable;
	TimeProxy(Movable movable){
		this.movable = movable;
	}

	@Override
	public void move() {
		long start = System.currentTimeMillis();
		movable.move();
		long end = System.currentTimeMillis();
		System.out.println(end-start);
	}
}

class LogProxy implements Movable{

	Movable movable;
	LogProxy(Movable movable){
		this.movable = movable;
	}

	@Override
	public void move() {
		System.out.println("tank start move");
		movable.move();
		System.out.println("tank stop move");
	}
}

interface Movable{
	void move();
}
```

## 动态代理
> 在网上学习的时候,看到一个博客讲的特别好,可以参考 https://www.cnblogs.com/wyq1995/p/10936286.html
### 使用JDK生成代理对象
还是静态代理的需求,要对tank添加日志和运行时间的打印,这个时候,我们就不需要自己去写代码代理Tank类了,废话不多说,直接上代码
```java
public class DynamicProxy {

	public static void main(String[] args) {
		Tank tank = new Tank();
		//设置系统属性,把动态代理生成的class对象保存下来
		System.getProperties().put("sun.misc.ProxyGenerator.saveGeneratedFiles", "true");
		Movable logMovable = (Movable) Proxy.newProxyInstance(DynamicProxy.class.getClassLoader(),
				new Class[]{Movable.class},
				(proxy, method, args1) -> {
					System.out.println("method " + method.getName() + " start..");
					Object invoke = method.invoke(tank, args1);
					System.out.println("method " + method.getName() + " stop..");
					return invoke;
				});
		Movable timeMovable = (Movable) Proxy.newProxyInstance(DynamicProxy.class.getClassLoader(),
				new Class[]{Movable.class},
				(proxy, method, args1) -> {
					long start = System.currentTimeMillis();
					Object invoke = method.invoke(logMovable, args1);
					long end = System.currentTimeMillis();
					System.out.println("time: " + (end - start));
					return invoke;
				});
		timeMovable.move();

	}

	static class Tank implements Movable {

		@Override
		public void move() {
			System.out.println("Tank move...");
			try {
				Thread.sleep(new Random().nextInt(10000));
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		}
	}

	interface Movable {
		void move();
	}
}
```
因为动态代理生成的class我们看不到,不知道怎么实现,不方便理解,所以添加了一个参数,把JDK动态代理生成的class文件保存下来,然后用idea打开,可以看到大致内容,方便理解

JDK动态代理的核心代码就是下面这个方法
```java
public static Object newProxyInstance(ClassLoader loader,Class<?>[] interfaces,InvocationHandler h)
```
- 第一个参数是一个ClassLoder对象,可以是任意类的类加载器,通常使用被代理对象的类加载器
- 第二个参数是产生的代理对象要实现的接口数组,这里一般就填写被代理对象实现的接口
- 第三个参数最重要,这个一个接口类型,这个接口里面只有一个invoke方法,我这里使用了Lamda表达式写了这个接口的实现,这个接口的三个参数分别是
```java
public Object invoke(Object proxy, Method method, Object[] args)
```
  - 第一个是生成的代理对象
  - 第二个参数是被代理对象的方法对象
  - 第三个参数是执行方法的参数
- 最后的返回值就是生成的代理对象

我们调用生成的代理对象的move方法,会首先执行我们自己实现的InvocationHandler里面的invoke方法,然后我们在invoke方法中完成自己想要的操作,然后调用被代理对象的方法 ***Object invoke = method.invoke(logMovable, args1);*** 把被代理对象和参数传进去,就会继续调用被代理对象的方法了.
执行方法后我们我看到根目录生成了代理对象的class文件,直接用idea打开,就可以看到类似代码
<details>
<summary>生成的代理对象Class</summary>

```java
 final class $Proxy0 extends Proxy implements Movable {
    private static Method m1;
    private static Method m3;
    private static Method m2;
    private static Method m0;

    public $Proxy0(InvocationHandler var1) throws  {
        super(var1);
    }

    public final boolean equals(Object var1) throws  {
        try {
            return (Boolean)super.h.invoke(this, m1, new Object[]{var1});
        } catch (RuntimeException | Error var3) {
            throw var3;
        } catch (Throwable var4) {
            throw new UndeclaredThrowableException(var4);
        }
    }

    public final void move() throws  {
        try {
            super.h.invoke(this, m3, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    public final String toString() throws  {
        try {
            return (String)super.h.invoke(this, m2, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    public final int hashCode() throws  {
        try {
            return (Integer)super.h.invoke(this, m0, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    static {
        try {
            m1 = Class.forName("java.lang.Object").getMethod("equals", Class.forName("java.lang.Object"));
            m3 = Class.forName("com.test.proxy.DynamicProxy$Movable").getMethod("move");
            m2 = Class.forName("java.lang.Object").getMethod("toString");
            m0 = Class.forName("java.lang.Object").getMethod("hashCode");
        } catch (NoSuchMethodException var2) {
            throw new NoSuchMethodError(var2.getMessage());
        } catch (ClassNotFoundException var3) {
            throw new NoClassDefFoundError(var3.getMessage());
        }
    }
}
```
</details>

由Class文件可以看到生成的代理对象继承了Proxy对象,同时实现了Movable接口,在静态代码块里面分别加载了Object对象的方法和Movable的方法,m3是Movable里面的方法
我们再看class里面的move方法,调用了 ***super.h.invoke(this, m3, (Object[])null);*** 调用了父类的h对象的Invoke方法,这个h对象就是我们实现的InvocationHandler对象,这里就很清晰了.为什么会执行我们自定义的Invoke方法

### 使用cglib生成动态代理
> 同样,可以参考这个博客 https://www.cnblogs.com/wyq1995/p/10945034.html
首先,引入cglib的依赖
```maven
<dependency>
    <groupId>cglib</groupId>
    <artifactId>cglib</artifactId>
    <version>3.1</version>
</dependency>
```
然后直接看代码
```java
public class CglibTest {
	/**
	 * 要代理的对象
	 */
	static class Tank {

		void move(){
			System.out.println("tank move...");
			try {
				Thread.sleep(new Random().nextInt(10000));
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		}

		final void fire(){
			System.out.println("tank fire...");
		}
	}

	/**
	 * 拦截类
	 */
	static class MyMethodInterceptor implements MethodInterceptor{

		/**
		 *
		 * @param o 产生的代理对象
		 * @param method 被代理类中的方法
		 * @param objects 方法的参数数组
		 * @param methodProxy 代理对象的代理方法
		 * @return
		 * @throws Throwable
		 */
		@Override
		public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable {
			long start = System.currentTimeMillis();
			Object o1 = methodProxy.invokeSuper(o, objects);
			long end = System.currentTimeMillis();
			System.out.println("time: "+ (end - start));
			return o1;
		}
	}

	public static void main(String[] args) {
		//把生成的代理类保存到项目根目录
		System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY,".");
		Enhancer enhancer = new Enhancer();
		enhancer.setSuperclass(Tank.class);
		enhancer.setCallback(new MyMethodInterceptor());
		Tank t = (Tank)enhancer.create();
		t.move();
		t.fire();
	}
}
```
结果如下
```txt
tank move...
time: 525
tank fire...
```
可以看到,只有move方法打印了时间,fire方法没有打印时间,因为Cglib的原理是继承被代理类,而fire方法被final修饰,无法重写,所以没有被代理
同样的,我们把代理类保存到根目录了,方便我们查看理解,class代码如下
<details>
<summary>Tan对象的FastClass</summary>
	
```java
public class CglibTest$Tank$$EnhancerByCGLIB$$79f23478$$FastClassByCGLIB$$7bebd8dd extends FastClass {
    public CglibTest$Tank$$EnhancerByCGLIB$$79f23478$$FastClassByCGLIB$$7bebd8dd(Class var1) {
        super(var1);
    }

    public int getIndex(Signature var1) {
        String var10000 = var1.toString();
        switch(var10000.hashCode()) {
        case -2055565910:
            if (var10000.equals("CGLIB$SET_THREAD_CALLBACKS([Lnet/sf/cglib/proxy/Callback;)V")) {
                return 17;
            }
            break;
        case -1725733088:
            if (var10000.equals("getClass()Ljava/lang/Class;")) {
                return 25;
            }
            break;
        case -1457535688:
            if (var10000.equals("CGLIB$STATICHOOK1()V")) {
                return 20;
            }
            break;
        case -1411812934:
            if (var10000.equals("CGLIB$hashCode$4()I")) {
                return 13;
            }
            break;
        case -1026001249:
            if (var10000.equals("wait(JI)V")) {
                return 23;
            }
            break;
        case -894172689:
            if (var10000.equals("newInstance(Lnet/sf/cglib/proxy/Callback;)Ljava/lang/Object;")) {
                return 3;
            }
            break;
        case -849514113:
            if (var10000.equals("fire()V")) {
                return 21;
            }
            break;
        case -623122092:
            if (var10000.equals("CGLIB$findMethodProxy(Lnet/sf/cglib/core/Signature;)Lnet/sf/cglib/proxy/MethodProxy;")) {
                return 19;
            }
            break;
        case -419626537:
            if (var10000.equals("setCallbacks([Lnet/sf/cglib/proxy/Callback;)V")) {
                return 16;
            }
            break;
        case 243996900:
            if (var10000.equals("wait(J)V")) {
                return 24;
            }
            break;
        case 374345669:
            if (var10000.equals("CGLIB$equals$2(Ljava/lang/Object;)Z")) {
                return 10;
            }
            break;
        case 560567118:
            if (var10000.equals("setCallback(ILnet/sf/cglib/proxy/Callback;)V")) {
                return 6;
            }
            break;
        case 588777685:
            if (var10000.equals("CGLIB$move$0()V")) {
                return 8;
            }
            break;
        case 811063227:
            if (var10000.equals("newInstance([Ljava/lang/Class;[Ljava/lang/Object;[Lnet/sf/cglib/proxy/Callback;)Ljava/lang/Object;")) {
                return 5;
            }
            break;
        case 946854621:
            if (var10000.equals("notifyAll()V")) {
                return 27;
            }
            break;
        case 973717575:
            if (var10000.equals("getCallbacks()[Lnet/sf/cglib/proxy/Callback;")) {
                return 14;
            }
            break;
        case 1116248544:
            if (var10000.equals("wait()V")) {
                return 22;
            }
            break;
        case 1221173700:
            if (var10000.equals("newInstance([Lnet/sf/cglib/proxy/Callback;)Ljava/lang/Object;")) {
                return 4;
            }
            break;
        case 1230699260:
            if (var10000.equals("getCallback(I)Lnet/sf/cglib/proxy/Callback;")) {
                return 15;
            }
            break;
        case 1243513348:
            if (var10000.equals("move()V")) {
                return 7;
            }
            break;
        case 1365077639:
            if (var10000.equals("CGLIB$finalize$1()V")) {
                return 9;
            }
            break;
        case 1517819849:
            if (var10000.equals("CGLIB$toString$3()Ljava/lang/String;")) {
                return 11;
            }
            break;
        case 1584330438:
            if (var10000.equals("CGLIB$SET_STATIC_CALLBACKS([Lnet/sf/cglib/proxy/Callback;)V")) {
                return 18;
            }
            break;
        case 1826985398:
            if (var10000.equals("equals(Ljava/lang/Object;)Z")) {
                return 0;
            }
            break;
        case 1902039948:
            if (var10000.equals("notify()V")) {
                return 26;
            }
            break;
        case 1913648695:
            if (var10000.equals("toString()Ljava/lang/String;")) {
                return 1;
            }
            break;
        case 1984935277:
            if (var10000.equals("hashCode()I")) {
                return 2;
            }
            break;
        case 2011844968:
            if (var10000.equals("CGLIB$clone$5()Ljava/lang/Object;")) {
                return 12;
            }
        }

        return -1;
    }

    public int getIndex(String var1, Class[] var2) {
        switch(var1.hashCode()) {
        case -2083498450:
            if (var1.equals("CGLIB$finalize$1")) {
                switch(var2.length) {
                case 0:
                    return 9;
                }
            }
            break;
        case -1776922004:
            if (var1.equals("toString")) {
                switch(var2.length) {
                case 0:
                    return 1;
                }
            }
            break;
        case -1295482945:
            if (var1.equals("equals")) {
                switch(var2.length) {
                case 1:
                    if (var2[0].getName().equals("java.lang.Object")) {
                        return 0;
                    }
                }
            }
            break;
        case -1053468136:
            if (var1.equals("getCallbacks")) {
                switch(var2.length) {
                case 0:
                    return 14;
                }
            }
            break;
        case -1039689911:
            if (var1.equals("notify")) {
                switch(var2.length) {
                case 0:
                    return 26;
                }
            }
            break;
        case -124978608:
            if (var1.equals("CGLIB$equals$2")) {
                switch(var2.length) {
                case 1:
                    if (var2[0].getName().equals("java.lang.Object")) {
                        return 10;
                    }
                }
            }
            break;
        case -60403779:
            if (var1.equals("CGLIB$SET_STATIC_CALLBACKS")) {
                switch(var2.length) {
                case 1:
                    if (var2[0].getName().equals("[Lnet.sf.cglib.proxy.Callback;")) {
                        return 18;
                    }
                }
            }
            break;
        case -29025554:
            if (var1.equals("CGLIB$hashCode$4")) {
                switch(var2.length) {
                case 0:
                    return 13;
                }
            }
            break;
        case 3143222:
            if (var1.equals("fire")) {
                switch(var2.length) {
                case 0:
                    return 21;
                }
            }
            break;
        case 3357649:
            if (var1.equals("move")) {
                switch(var2.length) {
                case 0:
                    return 7;
                }
            }
            break;
        case 3641717:
            if (var1.equals("wait")) {
                switch(var2.length) {
                case 0:
                    return 22;
                case 1:
                    if (var2[0].getName().equals("long")) {
                        return 24;
                    }
                    break;
                case 2:
                    if (var2[0].getName().equals("long") && var2[1].getName().equals("int")) {
                        return 23;
                    }
                }
            }
            break;
        case 85179481:
            if (var1.equals("CGLIB$SET_THREAD_CALLBACKS")) {
                switch(var2.length) {
                case 1:
                    if (var2[0].getName().equals("[Lnet.sf.cglib.proxy.Callback;")) {
                        return 17;
                    }
                }
            }
            break;
        case 147696667:
            if (var1.equals("hashCode")) {
                switch(var2.length) {
                case 0:
                    return 2;
                }
            }
            break;
        case 161998109:
            if (var1.equals("CGLIB$STATICHOOK1")) {
                switch(var2.length) {
                case 0:
                    return 20;
                }
            }
            break;
        case 352226976:
            if (var1.equals("CGLIB$move$0")) {
                switch(var2.length) {
                case 0:
                    return 8;
                }
            }
            break;
        case 495524492:
            if (var1.equals("setCallbacks")) {
                switch(var2.length) {
                case 1:
                    if (var2[0].getName().equals("[Lnet.sf.cglib.proxy.Callback;")) {
                        return 16;
                    }
                }
            }
            break;
        case 1154623345:
            if (var1.equals("CGLIB$findMethodProxy")) {
                switch(var2.length) {
                case 1:
                    if (var2[0].getName().equals("net.sf.cglib.core.Signature")) {
                        return 19;
                    }
                }
            }
            break;
        case 1543336190:
            if (var1.equals("CGLIB$toString$3")) {
                switch(var2.length) {
                case 0:
                    return 11;
                }
            }
            break;
        case 1811874389:
            if (var1.equals("newInstance")) {
                switch(var2.length) {
                case 1:
                    String var10001 = var2[0].getName();
                    switch(var10001.hashCode()) {
                    case -845341380:
                        if (var10001.equals("net.sf.cglib.proxy.Callback")) {
                            return 3;
                        }
                        break;
                    case 1730110032:
                        if (var10001.equals("[Lnet.sf.cglib.proxy.Callback;")) {
                            return 4;
                        }
                    }
                case 2:
                default:
                    break;
                case 3:
                    if (var2[0].getName().equals("[Ljava.lang.Class;") && var2[1].getName().equals("[Ljava.lang.Object;") && var2[2].getName().equals("[Lnet.sf.cglib.proxy.Callback;")) {
                        return 5;
                    }
                }
            }
            break;
        case 1817099975:
            if (var1.equals("setCallback")) {
                switch(var2.length) {
                case 2:
                    if (var2[0].getName().equals("int") && var2[1].getName().equals("net.sf.cglib.proxy.Callback")) {
                        return 6;
                    }
                }
            }
            break;
        case 1902066072:
            if (var1.equals("notifyAll")) {
                switch(var2.length) {
                case 0:
                    return 27;
                }
            }
            break;
        case 1905679803:
            if (var1.equals("getCallback")) {
                switch(var2.length) {
                case 1:
                    if (var2[0].getName().equals("int")) {
                        return 15;
                    }
                }
            }
            break;
        case 1950568386:
            if (var1.equals("getClass")) {
                switch(var2.length) {
                case 0:
                    return 25;
                }
            }
            break;
        case 1951977611:
            if (var1.equals("CGLIB$clone$5")) {
                switch(var2.length) {
                case 0:
                    return 12;
                }
            }
        }

        return -1;
    }

    public int getIndex(Class[] var1) {
        switch(var1.length) {
        case 0:
            return 0;
        default:
            return -1;
        }
    }

    public Object invoke(int var1, Object var2, Object[] var3) throws InvocationTargetException {
        79f23478 var10000 = (79f23478)var2;
        int var10001 = var1;

        try {
            switch(var10001) {
            case 0:
                return new Boolean(var10000.equals(var3[0]));
            case 1:
                return var10000.toString();
            case 2:
                return new Integer(var10000.hashCode());
            case 3:
                return var10000.newInstance((Callback)var3[0]);
            case 4:
                return var10000.newInstance((Callback[])var3[0]);
            case 5:
                return var10000.newInstance((Class[])var3[0], (Object[])var3[1], (Callback[])var3[2]);
            case 6:
                var10000.setCallback(((Number)var3[0]).intValue(), (Callback)var3[1]);
                return null;
            case 7:
                var10000.move();
                return null;
            case 8:
                var10000.CGLIB$move$0();
                return null;
            case 9:
                var10000.CGLIB$finalize$1();
                return null;
            case 10:
                return new Boolean(var10000.CGLIB$equals$2(var3[0]));
            case 11:
                return var10000.CGLIB$toString$3();
            case 12:
                return var10000.CGLIB$clone$5();
            case 13:
                return new Integer(var10000.CGLIB$hashCode$4());
            case 14:
                return var10000.getCallbacks();
            case 15:
                return var10000.getCallback(((Number)var3[0]).intValue());
            case 16:
                var10000.setCallbacks((Callback[])var3[0]);
                return null;
            case 17:
                79f23478.CGLIB$SET_THREAD_CALLBACKS((Callback[])var3[0]);
                return null;
            case 18:
                79f23478.CGLIB$SET_STATIC_CALLBACKS((Callback[])var3[0]);
                return null;
            case 19:
                return 79f23478.CGLIB$findMethodProxy((Signature)var3[0]);
            case 20:
                79f23478.CGLIB$STATICHOOK1();
                return null;
            case 21:
                var10000.fire();
                return null;
            case 22:
                var10000.wait();
                return null;
            case 23:
                var10000.wait(((Number)var3[0]).longValue(), ((Number)var3[1]).intValue());
                return null;
            case 24:
                var10000.wait(((Number)var3[0]).longValue());
                return null;
            case 25:
                return var10000.getClass();
            case 26:
                var10000.notify();
                return null;
            case 27:
                var10000.notifyAll();
                return null;
            }
        } catch (Throwable var4) {
            throw new InvocationTargetException(var4);
        }

        throw new IllegalArgumentException("Cannot find matching method/constructor");
    }

    public Object newInstance(int var1, Object[] var2) throws InvocationTargetException {
        79f23478 var10000 = new 79f23478;
        79f23478 var10001 = var10000;
        int var10002 = var1;

        try {
            switch(var10002) {
            case 0:
                var10001.<init>();
                return var10000;
            }
        } catch (Throwable var3) {
            throw new InvocationTargetException(var3);
        }

        throw new IllegalArgumentException("Cannot find matching method/constructor");
    }

    public int getMaxIndex() {
        return 27;
    }
}
```
</details>
<details>
<summary>生成的代理对象Class</summary>
	
```java
public class CglibTest$Tank$$EnhancerByCGLIB$$79f23478 extends Tank implements Factory {
    private boolean CGLIB$BOUND;
    private static final ThreadLocal CGLIB$THREAD_CALLBACKS;
    private static final Callback[] CGLIB$STATIC_CALLBACKS;
    private MethodInterceptor CGLIB$CALLBACK_0;
    private static final Method CGLIB$move$0$Method;
    private static final MethodProxy CGLIB$move$0$Proxy;
    private static final Object[] CGLIB$emptyArgs;
    private static final Method CGLIB$finalize$1$Method;
    private static final MethodProxy CGLIB$finalize$1$Proxy;
    private static final Method CGLIB$equals$2$Method;
    private static final MethodProxy CGLIB$equals$2$Proxy;
    private static final Method CGLIB$toString$3$Method;
    private static final MethodProxy CGLIB$toString$3$Proxy;
    private static final Method CGLIB$hashCode$4$Method;
    private static final MethodProxy CGLIB$hashCode$4$Proxy;
    private static final Method CGLIB$clone$5$Method;
    private static final MethodProxy CGLIB$clone$5$Proxy;

    static void CGLIB$STATICHOOK1() {
        CGLIB$THREAD_CALLBACKS = new ThreadLocal();
        CGLIB$emptyArgs = new Object[0];
        Class var0 = Class.forName("com.zhaocheng.proxy.CglibTest$Tank$$EnhancerByCGLIB$$79f23478");
        Class var1;
        Method[] var10000 = ReflectUtils.findMethods(new String[]{"finalize", "()V", "equals", "(Ljava/lang/Object;)Z", "toString", "()Ljava/lang/String;", "hashCode", "()I", "clone", "()Ljava/lang/Object;"}, (var1 = Class.forName("java.lang.Object")).getDeclaredMethods());
        CGLIB$finalize$1$Method = var10000[0];
        CGLIB$finalize$1$Proxy = MethodProxy.create(var1, var0, "()V", "finalize", "CGLIB$finalize$1");
        CGLIB$equals$2$Method = var10000[1];
        CGLIB$equals$2$Proxy = MethodProxy.create(var1, var0, "(Ljava/lang/Object;)Z", "equals", "CGLIB$equals$2");
        CGLIB$toString$3$Method = var10000[2];
        CGLIB$toString$3$Proxy = MethodProxy.create(var1, var0, "()Ljava/lang/String;", "toString", "CGLIB$toString$3");
        CGLIB$hashCode$4$Method = var10000[3];
        CGLIB$hashCode$4$Proxy = MethodProxy.create(var1, var0, "()I", "hashCode", "CGLIB$hashCode$4");
        CGLIB$clone$5$Method = var10000[4];
        CGLIB$clone$5$Proxy = MethodProxy.create(var1, var0, "()Ljava/lang/Object;", "clone", "CGLIB$clone$5");
        CGLIB$move$0$Method = ReflectUtils.findMethods(new String[]{"move", "()V"}, (var1 = Class.forName("com.zhaocheng.proxy.CglibTest$Tank")).getDeclaredMethods())[0];
        CGLIB$move$0$Proxy = MethodProxy.create(var1, var0, "()V", "move", "CGLIB$move$0");
    }

    final void CGLIB$move$0() {
        super.move();
    }

    final void move() {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_0;
        }

        if (var10000 != null) {
            var10000.intercept(this, CGLIB$move$0$Method, CGLIB$emptyArgs, CGLIB$move$0$Proxy);
        } else {
            super.move();
        }
    }

    final void CGLIB$finalize$1() throws Throwable {
        super.finalize();
    }

    protected final void finalize() throws Throwable {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_0;
        }

        if (var10000 != null) {
            var10000.intercept(this, CGLIB$finalize$1$Method, CGLIB$emptyArgs, CGLIB$finalize$1$Proxy);
        } else {
            super.finalize();
        }
    }

    final boolean CGLIB$equals$2(Object var1) {
        return super.equals(var1);
    }

    public final boolean equals(Object var1) {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_0;
        }

        if (var10000 != null) {
            Object var2 = var10000.intercept(this, CGLIB$equals$2$Method, new Object[]{var1}, CGLIB$equals$2$Proxy);
            return var2 == null ? false : (Boolean)var2;
        } else {
            return super.equals(var1);
        }
    }

    final String CGLIB$toString$3() {
        return super.toString();
    }

    public final String toString() {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_0;
        }

        return var10000 != null ? (String)var10000.intercept(this, CGLIB$toString$3$Method, CGLIB$emptyArgs, CGLIB$toString$3$Proxy) : super.toString();
    }

    final int CGLIB$hashCode$4() {
        return super.hashCode();
    }

    public final int hashCode() {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_0;
        }

        if (var10000 != null) {
            Object var1 = var10000.intercept(this, CGLIB$hashCode$4$Method, CGLIB$emptyArgs, CGLIB$hashCode$4$Proxy);
            return var1 == null ? 0 : ((Number)var1).intValue();
        } else {
            return super.hashCode();
        }
    }

    final Object CGLIB$clone$5() throws CloneNotSupportedException {
        return super.clone();
    }

    protected final Object clone() throws CloneNotSupportedException {
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;
        if (var10000 == null) {
            CGLIB$BIND_CALLBACKS(this);
            var10000 = this.CGLIB$CALLBACK_0;
        }

        return var10000 != null ? var10000.intercept(this, CGLIB$clone$5$Method, CGLIB$emptyArgs, CGLIB$clone$5$Proxy) : super.clone();
    }

    public static MethodProxy CGLIB$findMethodProxy(Signature var0) {
        String var10000 = var0.toString();
        switch(var10000.hashCode()) {
        case -1574182249:
            if (var10000.equals("finalize()V")) {
                return CGLIB$finalize$1$Proxy;
            }
            break;
        case -508378822:
            if (var10000.equals("clone()Ljava/lang/Object;")) {
                return CGLIB$clone$5$Proxy;
            }
            break;
        case 1243513348:
            if (var10000.equals("move()V")) {
                return CGLIB$move$0$Proxy;
            }
            break;
        case 1826985398:
            if (var10000.equals("equals(Ljava/lang/Object;)Z")) {
                return CGLIB$equals$2$Proxy;
            }
            break;
        case 1913648695:
            if (var10000.equals("toString()Ljava/lang/String;")) {
                return CGLIB$toString$3$Proxy;
            }
            break;
        case 1984935277:
            if (var10000.equals("hashCode()I")) {
                return CGLIB$hashCode$4$Proxy;
            }
        }

        return null;
    }

    public CglibTest$Tank$$EnhancerByCGLIB$$79f23478() {
        CGLIB$BIND_CALLBACKS(this);
    }

    public static void CGLIB$SET_THREAD_CALLBACKS(Callback[] var0) {
        CGLIB$THREAD_CALLBACKS.set(var0);
    }

    public static void CGLIB$SET_STATIC_CALLBACKS(Callback[] var0) {
        CGLIB$STATIC_CALLBACKS = var0;
    }

    private static final void CGLIB$BIND_CALLBACKS(Object var0) {
        CglibTest$Tank$$EnhancerByCGLIB$$79f23478 var1 = (CglibTest$Tank$$EnhancerByCGLIB$$79f23478)var0;
        if (!var1.CGLIB$BOUND) {
            var1.CGLIB$BOUND = true;
            Object var10000 = CGLIB$THREAD_CALLBACKS.get();
            if (var10000 == null) {
                var10000 = CGLIB$STATIC_CALLBACKS;
                if (var10000 == null) {
                    return;
                }
            }

            var1.CGLIB$CALLBACK_0 = (MethodInterceptor)((Callback[])var10000)[0];
        }

    }

    public Object newInstance(Callback[] var1) {
        CGLIB$SET_THREAD_CALLBACKS(var1);
        CglibTest$Tank$$EnhancerByCGLIB$$79f23478 var10000 = new CglibTest$Tank$$EnhancerByCGLIB$$79f23478();
        CGLIB$SET_THREAD_CALLBACKS((Callback[])null);
        return var10000;
    }

    public Object newInstance(Callback var1) {
        CGLIB$SET_THREAD_CALLBACKS(new Callback[]{var1});
        CglibTest$Tank$$EnhancerByCGLIB$$79f23478 var10000 = new CglibTest$Tank$$EnhancerByCGLIB$$79f23478();
        CGLIB$SET_THREAD_CALLBACKS((Callback[])null);
        return var10000;
    }

    public Object newInstance(Class[] var1, Object[] var2, Callback[] var3) {
        CGLIB$SET_THREAD_CALLBACKS(var3);
        CglibTest$Tank$$EnhancerByCGLIB$$79f23478 var10000 = new CglibTest$Tank$$EnhancerByCGLIB$$79f23478;
        switch(var1.length) {
        case 0:
            var10000.<init>();
            CGLIB$SET_THREAD_CALLBACKS((Callback[])null);
            return var10000;
        default:
            throw new IllegalArgumentException("Constructor not found");
        }
    }

    public Callback getCallback(int var1) {
        CGLIB$BIND_CALLBACKS(this);
        MethodInterceptor var10000;
        switch(var1) {
        case 0:
            var10000 = this.CGLIB$CALLBACK_0;
            break;
        default:
            var10000 = null;
        }

        return var10000;
    }

    public void setCallback(int var1, Callback var2) {
        switch(var1) {
        case 0:
            this.CGLIB$CALLBACK_0 = (MethodInterceptor)var2;
        default:
        }
    }

    public Callback[] getCallbacks() {
        CGLIB$BIND_CALLBACKS(this);
        return new Callback[]{this.CGLIB$CALLBACK_0};
    }

    public void setCallbacks(Callback[] var1) {
        this.CGLIB$CALLBACK_0 = (MethodInterceptor)var1[0];
    }

    static {
        CGLIB$STATICHOOK1();
    }
}
```
</details>
<details>
<summary>生成的代理对象的FastClass</summary>
	
```java
public class CglibTest$Tank$$EnhancerByCGLIB$$79f23478$$FastClassByCGLIB$$7bebd8dd extends FastClass {
    public CglibTest$Tank$$EnhancerByCGLIB$$79f23478$$FastClassByCGLIB$$7bebd8dd(Class var1) {
        super(var1);
    }

    public int getIndex(Signature var1) {
        String var10000 = var1.toString();
        switch(var10000.hashCode()) {
        case -2055565910:
            if (var10000.equals("CGLIB$SET_THREAD_CALLBACKS([Lnet/sf/cglib/proxy/Callback;)V")) {
                return 17;
            }
            break;
        case -1725733088:
            if (var10000.equals("getClass()Ljava/lang/Class;")) {
                return 25;
            }
            break;
        case -1457535688:
            if (var10000.equals("CGLIB$STATICHOOK1()V")) {
                return 20;
            }
            break;
        case -1411812934:
            if (var10000.equals("CGLIB$hashCode$4()I")) {
                return 13;
            }
            break;
        case -1026001249:
            if (var10000.equals("wait(JI)V")) {
                return 23;
            }
            break;
        case -894172689:
            if (var10000.equals("newInstance(Lnet/sf/cglib/proxy/Callback;)Ljava/lang/Object;")) {
                return 3;
            }
            break;
        case -849514113:
            if (var10000.equals("fire()V")) {
                return 21;
            }
            break;
        case -623122092:
            if (var10000.equals("CGLIB$findMethodProxy(Lnet/sf/cglib/core/Signature;)Lnet/sf/cglib/proxy/MethodProxy;")) {
                return 19;
            }
            break;
        case -419626537:
            if (var10000.equals("setCallbacks([Lnet/sf/cglib/proxy/Callback;)V")) {
                return 16;
            }
            break;
        case 243996900:
            if (var10000.equals("wait(J)V")) {
                return 24;
            }
            break;
        case 374345669:
            if (var10000.equals("CGLIB$equals$2(Ljava/lang/Object;)Z")) {
                return 10;
            }
            break;
        case 560567118:
            if (var10000.equals("setCallback(ILnet/sf/cglib/proxy/Callback;)V")) {
                return 6;
            }
            break;
        case 588777685:
            if (var10000.equals("CGLIB$move$0()V")) {
                return 8;
            }
            break;
        case 811063227:
            if (var10000.equals("newInstance([Ljava/lang/Class;[Ljava/lang/Object;[Lnet/sf/cglib/proxy/Callback;)Ljava/lang/Object;")) {
                return 5;
            }
            break;
        case 946854621:
            if (var10000.equals("notifyAll()V")) {
                return 27;
            }
            break;
        case 973717575:
            if (var10000.equals("getCallbacks()[Lnet/sf/cglib/proxy/Callback;")) {
                return 14;
            }
            break;
        case 1116248544:
            if (var10000.equals("wait()V")) {
                return 22;
            }
            break;
        case 1221173700:
            if (var10000.equals("newInstance([Lnet/sf/cglib/proxy/Callback;)Ljava/lang/Object;")) {
                return 4;
            }
            break;
        case 1230699260:
            if (var10000.equals("getCallback(I)Lnet/sf/cglib/proxy/Callback;")) {
                return 15;
            }
            break;
        case 1243513348:
            if (var10000.equals("move()V")) {
                return 7;
            }
            break;
        case 1365077639:
            if (var10000.equals("CGLIB$finalize$1()V")) {
                return 9;
            }
            break;
        case 1517819849:
            if (var10000.equals("CGLIB$toString$3()Ljava/lang/String;")) {
                return 11;
            }
            break;
        case 1584330438:
            if (var10000.equals("CGLIB$SET_STATIC_CALLBACKS([Lnet/sf/cglib/proxy/Callback;)V")) {
                return 18;
            }
            break;
        case 1826985398:
            if (var10000.equals("equals(Ljava/lang/Object;)Z")) {
                return 0;
            }
            break;
        case 1902039948:
            if (var10000.equals("notify()V")) {
                return 26;
            }
            break;
        case 1913648695:
            if (var10000.equals("toString()Ljava/lang/String;")) {
                return 1;
            }
            break;
        case 1984935277:
            if (var10000.equals("hashCode()I")) {
                return 2;
            }
            break;
        case 2011844968:
            if (var10000.equals("CGLIB$clone$5()Ljava/lang/Object;")) {
                return 12;
            }
        }

        return -1;
    }

    public int getIndex(String var1, Class[] var2) {
        switch(var1.hashCode()) {
        case -2083498450:
            if (var1.equals("CGLIB$finalize$1")) {
                switch(var2.length) {
                case 0:
                    return 9;
                }
            }
            break;
        case -1776922004:
            if (var1.equals("toString")) {
                switch(var2.length) {
                case 0:
                    return 1;
                }
            }
            break;
        case -1295482945:
            if (var1.equals("equals")) {
                switch(var2.length) {
                case 1:
                    if (var2[0].getName().equals("java.lang.Object")) {
                        return 0;
                    }
                }
            }
            break;
        case -1053468136:
            if (var1.equals("getCallbacks")) {
                switch(var2.length) {
                case 0:
                    return 14;
                }
            }
            break;
        case -1039689911:
            if (var1.equals("notify")) {
                switch(var2.length) {
                case 0:
                    return 26;
                }
            }
            break;
        case -124978608:
            if (var1.equals("CGLIB$equals$2")) {
                switch(var2.length) {
                case 1:
                    if (var2[0].getName().equals("java.lang.Object")) {
                        return 10;
                    }
                }
            }
            break;
        case -60403779:
            if (var1.equals("CGLIB$SET_STATIC_CALLBACKS")) {
                switch(var2.length) {
                case 1:
                    if (var2[0].getName().equals("[Lnet.sf.cglib.proxy.Callback;")) {
                        return 18;
                    }
                }
            }
            break;
        case -29025554:
            if (var1.equals("CGLIB$hashCode$4")) {
                switch(var2.length) {
                case 0:
                    return 13;
                }
            }
            break;
        case 3143222:
            if (var1.equals("fire")) {
                switch(var2.length) {
                case 0:
                    return 21;
                }
            }
            break;
        case 3357649:
            if (var1.equals("move")) {
                switch(var2.length) {
                case 0:
                    return 7;
                }
            }
            break;
        case 3641717:
            if (var1.equals("wait")) {
                switch(var2.length) {
                case 0:
                    return 22;
                case 1:
                    if (var2[0].getName().equals("long")) {
                        return 24;
                    }
                    break;
                case 2:
                    if (var2[0].getName().equals("long") && var2[1].getName().equals("int")) {
                        return 23;
                    }
                }
            }
            break;
        case 85179481:
            if (var1.equals("CGLIB$SET_THREAD_CALLBACKS")) {
                switch(var2.length) {
                case 1:
                    if (var2[0].getName().equals("[Lnet.sf.cglib.proxy.Callback;")) {
                        return 17;
                    }
                }
            }
            break;
        case 147696667:
            if (var1.equals("hashCode")) {
                switch(var2.length) {
                case 0:
                    return 2;
                }
            }
            break;
        case 161998109:
            if (var1.equals("CGLIB$STATICHOOK1")) {
                switch(var2.length) {
                case 0:
                    return 20;
                }
            }
            break;
        case 352226976:
            if (var1.equals("CGLIB$move$0")) {
                switch(var2.length) {
                case 0:
                    return 8;
                }
            }
            break;
        case 495524492:
            if (var1.equals("setCallbacks")) {
                switch(var2.length) {
                case 1:
                    if (var2[0].getName().equals("[Lnet.sf.cglib.proxy.Callback;")) {
                        return 16;
                    }
                }
            }
            break;
        case 1154623345:
            if (var1.equals("CGLIB$findMethodProxy")) {
                switch(var2.length) {
                case 1:
                    if (var2[0].getName().equals("net.sf.cglib.core.Signature")) {
                        return 19;
                    }
                }
            }
            break;
        case 1543336190:
            if (var1.equals("CGLIB$toString$3")) {
                switch(var2.length) {
                case 0:
                    return 11;
                }
            }
            break;
        case 1811874389:
            if (var1.equals("newInstance")) {
                switch(var2.length) {
                case 1:
                    String var10001 = var2[0].getName();
                    switch(var10001.hashCode()) {
                    case -845341380:
                        if (var10001.equals("net.sf.cglib.proxy.Callback")) {
                            return 3;
                        }
                        break;
                    case 1730110032:
                        if (var10001.equals("[Lnet.sf.cglib.proxy.Callback;")) {
                            return 4;
                        }
                    }
                case 2:
                default:
                    break;
                case 3:
                    if (var2[0].getName().equals("[Ljava.lang.Class;") && var2[1].getName().equals("[Ljava.lang.Object;") && var2[2].getName().equals("[Lnet.sf.cglib.proxy.Callback;")) {
                        return 5;
                    }
                }
            }
            break;
        case 1817099975:
            if (var1.equals("setCallback")) {
                switch(var2.length) {
                case 2:
                    if (var2[0].getName().equals("int") && var2[1].getName().equals("net.sf.cglib.proxy.Callback")) {
                        return 6;
                    }
                }
            }
            break;
        case 1902066072:
            if (var1.equals("notifyAll")) {
                switch(var2.length) {
                case 0:
                    return 27;
                }
            }
            break;
        case 1905679803:
            if (var1.equals("getCallback")) {
                switch(var2.length) {
                case 1:
                    if (var2[0].getName().equals("int")) {
                        return 15;
                    }
                }
            }
            break;
        case 1950568386:
            if (var1.equals("getClass")) {
                switch(var2.length) {
                case 0:
                    return 25;
                }
            }
            break;
        case 1951977611:
            if (var1.equals("CGLIB$clone$5")) {
                switch(var2.length) {
                case 0:
                    return 12;
                }
            }
        }

        return -1;
    }

    public int getIndex(Class[] var1) {
        switch(var1.length) {
        case 0:
            return 0;
        default:
            return -1;
        }
    }

    public Object invoke(int var1, Object var2, Object[] var3) throws InvocationTargetException {
        79f23478 var10000 = (79f23478)var2;
        int var10001 = var1;

        try {
            switch(var10001) {
            case 0:
                return new Boolean(var10000.equals(var3[0]));
            case 1:
                return var10000.toString();
            case 2:
                return new Integer(var10000.hashCode());
            case 3:
                return var10000.newInstance((Callback)var3[0]);
            case 4:
                return var10000.newInstance((Callback[])var3[0]);
            case 5:
                return var10000.newInstance((Class[])var3[0], (Object[])var3[1], (Callback[])var3[2]);
            case 6:
                var10000.setCallback(((Number)var3[0]).intValue(), (Callback)var3[1]);
                return null;
            case 7:
                var10000.move();
                return null;
            case 8:
                var10000.CGLIB$move$0();
                return null;
            case 9:
                var10000.CGLIB$finalize$1();
                return null;
            case 10:
                return new Boolean(var10000.CGLIB$equals$2(var3[0]));
            case 11:
                return var10000.CGLIB$toString$3();
            case 12:
                return var10000.CGLIB$clone$5();
            case 13:
                return new Integer(var10000.CGLIB$hashCode$4());
            case 14:
                return var10000.getCallbacks();
            case 15:
                return var10000.getCallback(((Number)var3[0]).intValue());
            case 16:
                var10000.setCallbacks((Callback[])var3[0]);
                return null;
            case 17:
                79f23478.CGLIB$SET_THREAD_CALLBACKS((Callback[])var3[0]);
                return null;
            case 18:
                79f23478.CGLIB$SET_STATIC_CALLBACKS((Callback[])var3[0]);
                return null;
            case 19:
                return 79f23478.CGLIB$findMethodProxy((Signature)var3[0]);
            case 20:
                79f23478.CGLIB$STATICHOOK1();
                return null;
            case 21:
                var10000.fire();
                return null;
            case 22:
                var10000.wait();
                return null;
            case 23:
                var10000.wait(((Number)var3[0]).longValue(), ((Number)var3[1]).intValue());
                return null;
            case 24:
                var10000.wait(((Number)var3[0]).longValue());
                return null;
            case 25:
                return var10000.getClass();
            case 26:
                var10000.notify();
                return null;
            case 27:
                var10000.notifyAll();
                return null;
            }
        } catch (Throwable var4) {
            throw new InvocationTargetException(var4);
        }

        throw new IllegalArgumentException("Cannot find matching method/constructor");
    }

    public Object newInstance(int var1, Object[] var2) throws InvocationTargetException {
        79f23478 var10000 = new 79f23478;
        79f23478 var10001 = var10000;
        int var10002 = var1;

        try {
            switch(var10002) {
            case 0:
                var10001.<init>();
                return var10000;
            }
        } catch (Throwable var3) {
            throw new InvocationTargetException(var3);
        }

        throw new IllegalArgumentException("Cannot find matching method/constructor");
    }

    public int getMaxIndex() {
        return 27;
    }
}
```
</details>

整个流程如下:
- 第一步创建 ***Enhancer*** 对象
- 第二步调用creat方法创建代理对象
- 然后调用代理对象的move方法
- 查看生成的代理对象class文件,move方法是调用了我们自定义的intercept方法
- 我们在自定义的intercept方法中完成了要做的其他操作,然后调用父类的方法
- 通过查看源码,我们知道调用父类方法使用的是FsatClass的方式
